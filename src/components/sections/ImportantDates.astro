---
interface DateItem {
    event: string;
    date: string;
    isPassed?: boolean;
    isHighlighted?: boolean;
}

interface Props {
    title: string;
    subtitle?: string;
    dates: DateItem[];
}

const { title, subtitle, dates } = Astro.props;

// Helper to check if a date has passed
const isDatePassed = (dateStr: string) => {
    const today = new Date();
    const itemDate = new Date(dateStr);
    return today > itemDate;
};

// Process dates and add status
const processedDates = dates.map(date => ({
    ...date,
    isPassed: date.isPassed !== undefined ? date.isPassed : isDatePassed(date.date)
}));

// Group dates by month for visual organization
const groupedDates = processedDates.reduce((acc, date) => {
    const month = new Date(date.date).toLocaleString('default', { month: 'long', year: 'numeric' });
    if (!acc[month]) {
        acc[month] = [];
    }
    acc[month].push(date);
    return acc;
}, {} as Record<string, DateItem[]>);

// Format date for display (10th March 2025 format)
const formatDateWithSuffix = (dateStr: string) => {
    const date = new Date(dateStr);
    const day = date.getDate();

    // Add suffix to day (st, nd, rd, th)
    const suffix =
        day % 10 === 1 && day !== 11 ? 'st' :
        day % 10 === 2 && day !== 12 ? 'nd' :
        day % 10 === 3 && day !== 13 ? 'rd' : 'th';

    return date.toLocaleDateString('en-US', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
    }).replace(/\d+/, day + suffix);
};
---

<div class="py-20 bg-[#F7F7F7] rounded-xl border-l-4 border-[#1A7A64] shadow-md" id="important-dates">
    <div class="max-w-5xl mx-auto px-4">
        <div class="text-center mb-12">
            <h2 class="text-4xl font-bold text-[#2C3E50] mb-4">
                <span class="relative inline-block">
                    {title}
                    <span class="absolute bottom-0 left-0 w-full h-2 bg-gradient-to-r from-[#1A7A64]/20 to-[#4ECDC4]/30 rounded-full transform translate-y-2"></span>
                </span>
            </h2>
            {subtitle &&
                <p class="text-xl text-[#2C3E50]/80 mt-6 max-w-3xl mx-auto">
                    {subtitle}
                </p>
            }
        </div>

        <div class="timeline-container relative">
            <!-- Timeline line with animated dots -->
            <div class="absolute left-1/2 transform -translate-x-1/2 h-full">
                <div class="relative h-full">
                    <!-- Main line -->
                    <div class="absolute inset-0 w-1 bg-gradient-to-b from-[#1A7A64] to-[#0D3B66] rounded"></div>

                    <!-- Animated traveling dot -->
                    <div class="absolute w-3 h-3 bg-[#4ECDC4] rounded-full left-1/2 transform -translate-x-1/2 traveling-dot"></div>
                </div>
            </div>

												<!-- Timeline content -->
						<div class="relative z-10">
							{Object.entries(groupedDates).map(([month, monthDates], monthIndex) => (
								<div class="mb-14">
									<div class="flex justify-center">
										<div class="month-marker py-2 px-8 bg-gradient-to-r from-[#1A7A64] to-[#0D3B66] text-white rounded-full shadow-lg text-sm font-semibold mb-8 transform hover:scale-105 transition-transform duration-300">
											<span class="tracking-wider">{month}</span>
										</div>
									</div>

									<div class="space-y-10">
										{monthDates.map((dateItem, index) => {
											// Calculate global index across all months to maintain consistent alternation
											let globalIndex = monthIndex * 10 + index;

											// Check if this is one of the last three conference events
											const isPhysicalEvent =
												dateItem.event.includes("Camera-ready") ||
												dateItem.event.includes("Early Bird") ||
												dateItem.event.includes("Registration Deadline");

											return (
												<div class={`date-item flex flex-col md:flex-row items-center ${globalIndex % 2 === 0 ? 'md:flex-row-reverse' : ''} ${(dateItem.isHighlighted || isPhysicalEvent) ? 'highlighted-item' : ''}`}>
													<!-- Date -->
													<div class="date-side w-full md:w-1/2 px-4 flex md:justify-end">
														<div class={`date-badge px-5 py-3 rounded-xl shadow-md ${
															dateItem.isPassed
																? 'bg-[#2C3E50]/10 text-[#2C3E50]/60'
																: isPhysicalEvent
																	? 'bg-gradient-to-br from-[#4ECDC4] to-[#1A7A64] text-white border-2 border-[#4ECDC4]'
																	: dateItem.isHighlighted
																		? 'bg-gradient-to-br from-[#FF9F1C] to-[#FF8C00] text-white border-2 border-[#FF9F1C]'
																		: 'bg-gradient-to-br from-[#4ECDC4] to-[#1A7A64] text-white'
														} inline-block transform transition-all duration-300 hover:shadow-xl`}>
															<div class="flex items-center justify-center">
																<div class="text-center">
																	<span class="text-xl font-bold block">{new Date(dateItem.date).toLocaleDateString('default', { day: '2-digit' })}</span>
																	<span class="text-xs tracking-wide uppercase opacity-80">{new Date(dateItem.date).toLocaleDateString('default', { month: 'short' })}</span>
																</div>
																{(dateItem.isHighlighted || isPhysicalEvent) && (
																	<div class={`ml-2 w-2 h-2 rounded-full ${isPhysicalEvent ? 'bg-[#1A7A64] animate-ping-slow' : 'bg-white animate-ping-slow'}`}></div>
																)}
															</div>
														</div>
													</div>

													<!-- Timeline dot -->
													<div class="timeline-dot relative">
														<div class={`timeline-point absolute left-1/2 transform -translate-x-1/2 rounded-full ${
															dateItem.isPassed
																? 'w-4 h-4 bg-[#2C3E50]/30 border-4 border-[#2C3E50]/20'
																: isPhysicalEvent
																	? 'w-6 h-6 bg-[#1A7A64] border-[3px] border-[#4ECDC4]/70 animate-pulse-glow-green'
																	: dateItem.isHighlighted
																		? 'w-6 h-6 bg-[#FF9F1C] border-[3px] border-[#FF9F1C]/30 animate-pulse-glow'
																		: 'w-5 h-5 bg-[#1A7A64] border-4 border-[#4ECDC4]/30'
														}`}></div>
													</div>

													<!-- Event -->
													<div class="event-side w-full md:w-1/2 px-4">
														<div class={`event-card p-6 rounded-xl transition-all duration-300 ${
															dateItem.isPassed
																? 'bg-white/50 border border-[#2C3E50]/10'
																: isPhysicalEvent
																	? 'bg-white shadow-lg hover:shadow-xl border-l-4 border-[#1A7A64]'
																	: dateItem.isHighlighted
																		? 'bg-white shadow-lg hover:shadow-xl border-l-4 border-[#FF9F1C]'
																		: 'bg-white shadow-md hover:shadow-lg'
														}`}>
															<h3 class={`font-bold text-xl ${
																dateItem.isPassed
																	? 'text-[#2C3E50]/60'
																	: isPhysicalEvent
																		? 'text-[#1A7A64]'
																		: dateItem.isHighlighted
																			? 'text-[#FF9F1C]'
																			: 'text-[#1A7A64]'
															}`}>
																{dateItem.event}
															</h3>
															<p class={`mt-2 ${
																dateItem.isPassed
																	? 'text-[#2C3E50]/40'
																	: 'text-[#2C3E50]/70'
															}`}>
																{formatDateWithSuffix(dateItem.date)}
															</p>

															{!dateItem.isPassed && (
																<>
																	{isPhysicalEvent && (
																		<div class="mt-3 inline-block px-3 py-1 bg-[#1A7A64]/10 text-[#1A7A64] text-xs font-semibold rounded-full">
																			Hybrid Conference
																		</div>
																	)}

																	{dateItem.isHighlighted && !isPhysicalEvent && (
																		<div class="mt-3 inline-block px-3 py-1 bg-[#FF9F1C]/10 text-[#FF9F1C] text-xs font-semibold rounded-full">
																			Current Focus
																		</div>
																	)}
																</>
															)}
														</div>
													</div>
												</div>
											);
										})}
									</div>
								</div>
							))}
						</div>
        </div>

        <!-- Enhanced Legend -->
        <div class="mt-16 flex flex-wrap justify-center gap-8 text-sm">
            <div class="legend-item flex items-center gap-3 bg-white/80 px-4 py-2 rounded-lg shadow-sm">
                <div class="w-4 h-4 rounded-full bg-[#1A7A64] border-4 border-[#4ECDC4]/30"></div>
                <span class="text-[#2C3E50]">Upcoming Deadlines</span>
            </div>
            <div class="legend-item flex items-center gap-3 bg-white/80 px-4 py-2 rounded-lg shadow-sm">
                <div class="w-4 h-4 rounded-full bg-[#FF9F1C] border-4 border-[#FF9F1C]/30 animate-pulse-glow"></div>
                <span class="text-[#2C3E50]">Current Focus</span>
            </div>
            <div class="legend-item flex items-center gap-3 bg-white/80 px-4 py-2 rounded-lg shadow-sm">
                <div class="w-4 h-4 rounded-full bg-[#2C3E50]/30 border-4 border-[#2C3E50]/20"></div>
                <span class="text-[#2C3E50]">Past Deadlines</span>
            </div>
        </div>
    </div>
</div>

<style>
    .timeline-container {
        padding: 2rem 0;
    }

    .date-item {
        margin-bottom: 3rem;
        position: relative;
    }

    .timeline-dot {
        min-width: 30px;
        min-height: 30px;
        margin: 1rem 0;
    }

    .highlighted-item {
        z-index: 10;
    }

    /* Dot traveling animation along the timeline */
    @keyframes travel {
        0% {
            top: 0;
        }
        100% {
            top: 100%;
        }
    }

    .traveling-dot {
        animation: travel 30s linear infinite;
        box-shadow: 0 0 10px rgba(78, 205, 196, 0.8);
    }

    /* Enhanced glow effect for highlighted dates */
    @keyframes pulse-glow {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 0 0 rgba(255, 159, 28, 0.5);
        }
        50% {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 159, 28, 0.8);
        }
    }

    .animate-pulse-glow {
        animation: pulse-glow 2s ease-in-out infinite;
    }

    @keyframes ping-slow {
        0%, 100% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.8);
            opacity: 0;
        }
    }

    .animate-ping-slow {
        animation: ping-slow 1.5s cubic-bezier(0, 0, 0.2, 1) infinite;
    }

    /* Enhanced hover effects */
    .date-badge:hover {
        transform: translateY(-3px) scale(1.02);
    }

    .event-card:hover {
        transform: translateY(-2px);
    }

	@keyframes pulse-glow-green {
        0%, 100% {
            transform: scale(1);
            box-shadow: 0 0 0 rgba(26, 122, 100, 0.5);
        }
        50% {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(26, 122, 100, 0.8);
        }
    }

    .animate-pulse-glow-green {
        animation: pulse-glow-green 2s ease-in-out infinite;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .date-side, .event-side {
            width: 100%;
            text-align: center;
            margin-bottom: 0.75rem;
        }

        .timeline-dot {
            margin: 0.75rem 0;
        }

        .date-badge {
            margin: 0 auto;
            padding: 0.5rem 1rem;
        }

        .event-card {
            text-align: center;
        }
    }
</style>
